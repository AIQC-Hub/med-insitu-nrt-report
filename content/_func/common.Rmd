<style>
.panelset > .panel-tabs {
  display: flex;
}
.panelset > .panel-tabs li {
  flex: 1;
  text-align: center;
}
</style>

```{r, func_common, message = FALSE, warning = FALSE}

# Path
rsc_dir <- "../../data"
release_url <- "https://github.com/AIQC-Hub/insitu-nrt-report/releases/download/v0.1.0"

# Templates
template_path <- "./_template"
t_v_basic_info <- file.path(template_path, "var_basic_info.Rmd")
t_v_summary_stats <- file.path(template_path, "var_summary_stats.Rmd")
t_v_distributions <- file.path(template_path, "var_distribution.Rmd")
t_qc_basic_info <- file.path(template_path, "qc_basic_info.Rmd")
t_qc_summary_stats <- file.path(template_path, "qc_summary_stats.Rmd")
t_qc_distributions <- file.path(template_path, "qc_distribution.Rmd")
t_s_basic_info <- file.path(template_path, "summary_basic_info.Rmd")
t_s_location_filtering <- file.path(template_path, "summary_location_filtering.Rmd")
t_s_location_filtering2 <- file.path(template_path, "summary_location_filtering2.Rmd")
t_s_descriptive_stats <- file.path(template_path, "summary_descriptive_stats.Rmd")
t_s_locations <- file.path(template_path, "summary_locations.Rmd")
t_s_distribution_time <- file.path(template_path, "summary_distribution_time.Rmd")
t_s_duplicate_within <- file.path(template_path, "summary_duplicate_within.Rmd")
t_s_duplicate_within_details <- file.path(template_path, "summary_duplicate_within_details.Rmd")
t_s_duplicate_across <- file.path(template_path, "summary_duplicate_across.Rmd")
t_s_duplicate_across_details <- file.path(template_path, "summary_duplicate_across_details.Rmd")
t_s_observation_counts <- file.path(template_path, "summary_observation_counts.Rmd")
t_location_filtering <- file.path(template_path, "location_filtering.Rmd")

# Kable wrappers
kbl_table <- function(x) {
  kbl(x) %>% kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
}

# Common funcitons
create_dt_summary_tab <- function(df, cols=c('Lon', 'Lat')) {
  DT::datatable(df, rownames = FALSE,
      options = list(searching = TRUE, paging = TRUE, info = TRUE,
                     lengthMenu = list(c(10, 50, 100, -1), c("10", "50", "100", "All")))) %>%
    formatRound(columns = cols, digits = 1) %>%
    htmlwidgets::prependContent(tags$style(HTML('table.dataTable {font-size: 12px;}')))
}

na_summary <- function(data, var) {
  df <- data %>% mutate(uniq_prof = paste0(platform_code, profile_no))
  df_f <- df %>% filter(!is.na({{ var }}))
  tibble(
    Level = c("Platform", "Profile", "Observation"),
    `Total Count` = c(n_distinct(df$platform_code), n_distinct(df$uniq_prof), nrow(df)),
    `Non-NA Count` = c(n_distinct(df_f$platform_code), n_distinct(df_f$uniq_prof), nrow(df_f))
  ) %>%
  mutate(`Pct` = scales::percent(`Non-NA Count` / `Total Count`, accuracy = 0.1),
         `Total Count` = comma(`Total Count`),
         `Non-NA Count` = comma(`Non-NA Count`))
}

split_time_spans_common <- function(df, ts1, ts1_from, ts1_to, ts2, ts2_from, ts2_to,
                                    ts3, ts3_from, ts3_to, ts4, ts4_from, ts4_to) {
  df_year <- df %>%
    mutate(x = format(profile_timestamp, "%Y"))

  t1 <- df_year %>% filter(x >= ts1_from & x <= ts1_to)
  t2 <- df_year %>% filter(x >= ts2_from & x <= ts2_to)
  t3 <- df_year %>% filter(x >= ts3_from & x <= ts3_to)
  t4 <- df_year %>% filter(x >= ts4_from & x <= ts4_to)

  lst <- list(t1, t2, t3, t4)
  names(lst) = c(ts1, ts2, ts3, ts4)
  lst
}

filer_locations_common <- function(df, min_lon, max_lon, min_lat, max_lat) {
  setDT(df)

  keep_groups <- df[, .SD[1L, .(longitude, latitude)], by = .(platform_code, profile_no)][
    longitude >= min_lon & longitude <= max_lon &
    latitude  >= min_lat & latitude  <= max_lat,
    .(platform_code, profile_no)
  ]

  df[keep_groups, on = .(platform_code, profile_no)]
}

exclude_locations_common <- function(df, lon1, lat1, lon2, lat2) {
  setDT(df)

  first_positions <- df[, .SD[1L, .(longitude, latitude)],
                        by = .(platform_code, profile_no)]

  outside_box <- first_positions[
    !(longitude >= lon1 & longitude <= lon2 &
      latitude  >= lat1 & latitude  <= lat2),
    .(platform_code, profile_no)
  ]

  df[outside_box, on = .(platform_code, profile_no)]
}

get_unique_profile_no_common <- function(df, longitude_var, latitude_var) {
  df %>%
    distinct(platform_code, profile_no, profile_timestamp, {{ longitude_var }}, {{ latitude_var }}) %>%
    mutate(profile_no2 = paste(platform_code,
                               as.character(profile_timestamp),
                               profile_no,
                               as.character({{ longitude_var }}),
                               as.character({{ latitude_var }}), sep = "|")) %>%
    arrange(platform_code, profile_timestamp, .by_group = TRUE) %>%
    group_by(platform_code) %>%
    mutate(profile_no_uniq = dense_rank(profile_no2)) %>%
    ungroup()
}

update_profile_no_common <- function(df, df_profiles, longitude_var, latitude_var, longitude_var_name, latitude_var_name) {
  df %>%
    inner_join(df_profiles %>%
                 dplyr::select(platform_code, profile_no, profile_timestamp,
                               {{ longitude_var }}, {{ latitude_var }}, profile_no_uniq),
               by = c("platform_code", "profile_no", "profile_timestamp",
                      longitude_var_name, latitude_var_name)) %>%
    mutate(profile_no = profile_no_uniq) %>%
    dplyr::select(-profile_no_uniq)
}

find_duplicates_within_platforms_common <- function(df, longitude_var, latitude_var) {
  df %>%
    distinct(platform_code, profile_no, profile_timestamp, {{ longitude_var }}, {{ latitude_var }}) %>%
    mutate(lon2 = round({{ longitude_var }}, 3),
           lat2 = round({{ latitude_var }}, 3)) %>%
    group_by(platform_code, profile_timestamp, lon2, lat2) %>%
    summarise(profile_nos = paste0(profile_no, collapse = ","),
              n = n(),
              n2 = length(unique(platform_code))) %>%
    ungroup() %>%
    filter((n > 1) & (n2 == 1))
}

find_duplicates_across_platforms_common <- function(df, longitude_var, latitude_var) {
  df %>%
    distinct(platform_code, profile_no, profile_timestamp, {{ longitude_var }}, {{ latitude_var }}) %>%
    mutate(lon2 = round({{ longitude_var }}, 3),
           lat2 = round({{ latitude_var }}, 3)) %>%
    arrange(profile_timestamp, lon2, lat2) %>%
    group_by(profile_timestamp, lon2, lat2) %>%
    summarise(platform_codes = paste0(platform_code, collapse = ","),
              profile_nos = paste0(profile_no, collapse = ","),
              n = n(),
              n2 = length(unique(platform_code))) %>%
    filter((n > 1) & (n2 > 1))
}

summarise_df_dup_within_common <- function(df_orig, df_dup, longitude_var, latitude_var) {
  df_orig  %>%
    mutate(lon2 = round({{ longitude_var }}, 3),
           lat2 = round({{ latitude_var }}, 3)) %>%
    inner_join(df_dup %>% dplyr::select(-c(profile_nos, n)),
               by=c("platform_code", "profile_timestamp", "lon2", "lat2")) %>%
    group_by(platform_code, profile_no, profile_timestamp, lon2, lat2) %>%
    summarise(n = n(),
              avg_pres = mean(pres, na.rm = FALSE),
              avg_temp = mean(temp, na.rm = FALSE),
              avg_psal = mean(psal, na.rm = FALSE)) %>%
    ungroup()
}

summarise_df_dup_across_common <- function(df_orig, df_dup, longitude_var, latitude_var) {
  df_dup2 <- df_dup %>%
    mutate(
      platform_code = str_split(platform_codes, ","),
      profile_no = str_split(profile_nos, ",")
    ) %>%
    select(platform_code, profile_no) %>%
    unnest(c(platform_code, profile_no)) %>%
    mutate(profile_no = as.integer(profile_no))

  df_orig  %>%
    mutate(lon2 = round({{ longitude_var }}, 3),
           lat2 = round({{ latitude_var }}, 3)) %>%
    inner_join(df_dup2) %>%
    group_by(platform_code, profile_no, profile_timestamp, lon2, lat2) %>%
    summarise(n = n(),
              avg_pres = mean(pres, na.rm = FALSE),
              avg_temp = mean(temp, na.rm = FALSE),
              avg_psal = mean(psal, na.rm = FALSE)) %>%
    ungroup() %>%
    arrange(profile_timestamp, lon2, lat2)
}

remove_duplicates_within_platforms_common <- function(df_orig, df_dup_summary) {
  df_dup_keep <- df_dup_summary %>%
    arrange(platform_code, profile_timestamp, lon2, lat2,
            avg_pres, avg_deph, avg_temp, avg_psal, n) %>%
    group_by(platform_code, profile_timestamp, lon2, lat2) %>%
    summarise(profile_no = first(profile_no)) %>%
    ungroup() %>%
    dplyr::select(platform_code, profile_no)

  df_dup_remove <- df_dup_summary %>%
    distinct(platform_code, profile_no, profile_timestamp, lon2, lat2) %>%
    anti_join(df_dup_keep) %>%
    dplyr::select(platform_code, profile_no)

  df_orig %>% anti_join(df_dup_remove)
}

```
