```{r, message = FALSE, warning = FALSE}

create_nrt_cora_df_count_tab <- function(df_nrt, df_cora) {
  platform_nrt <- df_nrt %>% distinct(platform_code) %>% nrow()
  profile_nrt <- df_nrt %>% distinct(platform_code, profile_no) %>% nrow()
  obs_nrt <- df_nrt %>% summarise(n = sum(observation_no_count)) %>% pull(n)

  platform_cora <- df_cora %>% distinct(platform_code) %>% nrow()
  profile_cora <- df_cora %>% distinct(platform_code, profile_no) %>% nrow()
  obs_cora <- df_cora %>% summarise(n = sum(observation_no_count)) %>% pull(n)

  tibble(`Level` = c("Platform", "Profile", "Observation"),
         `NRT` = c(platform_nrt, profile_nrt, obs_nrt),
         `CORA` = c(platform_cora, profile_cora, obs_cora))
}

add_unique_ids <- function(df) {
  df %>%
    mutate(uniq_id_strict = paste(platform_code,
                                  as.character(profile_timestamp),
                                  as.character(round(longitude, 3)),
                                  as.character(round(latitude, 3)),
                                  as.character(observation_no_count), sep = "|"),
           uniq_id_relaxed = paste(platform_code,
                                   as.character(profile_timestamp),
                                   as.character(round(longitude)),
                                   as.character(round(latitude)), sep = "|"))
}

get_common_uniq_ids <- function(df_nrt_uniq_ids, df_cora_uniq_ids, id_name) {
  df_nrt_uniq_ids %>%
    filter({{ id_name }} %in% (df_cora_uniq_ids %>%
                                 distinct({{ id_name }} ) %>%
                                 pull({{ id_name }} ))) %>%
    distinct({{ id_name }} )
}

filter_df_by_common_ids <- function(df_uniq_ids, df_common_ids) {
  df_uniq_ids %>% inner_join(df_common_ids)
}

create_cora_nrt_intersection_tbl <- function(df_nrt, df_nrt_matched) {
  platform_nrt <- df_nrt %>% distinct(platform_code) %>% nrow()
  profile_nrt <- df_nrt %>% distinct(platform_code, profile_no) %>% nrow()
  obs_nrt <- df_nrt %>% summarise(n = sum(observation_no_count)) %>% pull(n)

  platform_mached <- df_nrt_matched %>% distinct(platform_code) %>% nrow()
  profile_mached <- df_nrt_matched %>% distinct(platform_code, profile_no) %>% nrow()
  obs_mached <- df_nrt_matched %>% summarise(n = sum(observation_no_count)) %>% pull(n)

  tibble(`Level` = c("Platform", "Profile", "Observation"),
         `NRT` = c(platform_nrt, profile_nrt, obs_nrt),
         `Matched` = c(platform_mached, profile_mached, obs_mached)) %>%
    mutate(Coverage = paste0((`Matched` / `NRT` * 100) %>% round(2), "%"))
}

distinct_profiles_by_common_uniq_ids <- function(df, id_name) {
  df_profiles <- df %>%
    group_by({{ id_name }}) %>%
    summarise(platform_code = first(platform_code),
              profile_no = first(profile_no),
              .groups = "drop") %>%
    distinct(platform_code, profile_no)

  df %>% inner_join(df_profiles)
}

```
